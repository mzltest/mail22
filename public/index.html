<!doctype html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="Generator" content="EditPlus®">
  <meta name="Author" content="">
  <meta name="Keywords" content="">
  <meta name="Description" content="">
  <title>Document</title>
</head>

<body>
  <script>
    var filechunks
    var filehashes
    var chunks //块数
    function handleFiles(files) {

      if (files.length) {
        let file = files[0];
        let reader = new FileReader();
        reader.onprogress = function (a) {
          document.getElementById('text').innerHTML = '=>[LOAD]' + a.loaded + '/' + a.total;
        }
        reader.onloadend = function () {
          filechunks = []
          filehashes = []
          chunksize = 256000
          chunks = Math.ceil(this.result.byteLength / chunksize)
          document.getElementById('text').innerHTML = '=>[CHUNKS]' + chunks

          for (var i = 0; i < chunks; i++) {
            filechunks.push(this.result.slice(i * 256000, (i + 1) * 256000))
            document.getElementById('text').innerHTML = '=>[SPLIT]' + (i + 1) + '/' + chunks;
          }
          document.getElementById('text').innerHTML = '=>[HASH]...';

          filechunks.forEach(elem => {
            window.crypto.subtle.digest('SHA-1', elem).then(hashBuffer => {
              hashhex = Array.from(new Uint8Array(hashBuffer)).map((b) => b.toString(16).padStart(2, '0')).join('');
              filehashes.push(hashhex);

            })



          });

          document.getElementById('text').innerHTML = '=>Ready to send.';
          document.getElementById('sendfile').setAttribute('onclick', 'send()')
          document.getElementById('sendfile').innerText='提交(1/3)'



        }
        reader.readAsArrayBuffer(file);
      }
    }




    function send() {

      console.log(filehashes)
      data = { filename: document.getElementById('file').files[0].name, hashes: filehashes }
      fetch('/init-upload', {
        method: 'POST', // or 'PUT'
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(data),
      })
        .then(response => response.json())
        .then(data => {
          console.log('Success:', data);
          document.getElementById('text').innerHTML = '=>Index sent:' + data.index;
          document.getElementById('key').value = data.index
          document.getElementById('sendfile').setAttribute('onclick', 'check()')
          document.getElementById('sendfile').innerText='检查(2/3)'
         
        })
        .catch((error) => {
          console.error('Error:', error);
        });


      

    }

    function check(){
      for (var i = 0; i < Math.ceil(chunks / 50); i++) {
            //request upload chunks
            data = { hashes:filehashes.slice(i*50,(i+1)*50) }
            fetch('/upload_preflight', {
              method: 'POST', // or 'PUT'
              headers: {
                'Content-Type': 'application/json',
              },
              body: JSON.stringify(data),
            })
              .then(response => response.json()).then(data=>{data.success.forEach(elem => {
                index=filehashes.indexOf(elem)
                delete filehashes[index]
                delete filechunks[index]
                console.log('already has chunk '+elem)
              });})
            document.getElementById('text').innerHTML = '=>[PREFLIGHT]' + (i+1) + '/' +  Math.ceil(chunks / 50);
          }
          document.getElementById('sendfile').setAttribute('onclick', 'upload()')
          document.getElementById('sendfile').innerText='上传(3/3)'
         

    }

    function upload(){
      

      for (var i = 0; i < Math.ceil(chunks / 20); i++) {
            //request upload chunks
            data = filechunks.slice(i*20,(i+1)*20)
            bdata=[]
            for (ii=0;ii<data.length;ii++){
              if (data[ii]){
bdata.push(  window.btoa(String.fromCharCode(...new Uint8Array(data[ii]))))
            }}
            fetch('/upload', {
              method: 'POST', // or 'PUT'
              headers: {
                'Content-Type': 'application/json',
              },
              body: JSON.stringify(bdata),
            })
              .then(response => response.json()).then(dat=>{
                dat.success.forEach(elem=>{
                  console.log(elem)
                 
                })
                document.getElementById('text').innerHTML = '=>[UPLOAD]Chunks' + i + '/' +  Math.ceil(chunks / 20);

              })


        }
        document.getElementById('text').innerHTML = '=>[UPLOAD]'
        document.getElementById('sendfile').setAttribute('hidden', 'true')
         
   


    }
  </script>
  <input type="file" id="file" onchange="handleFiles(this.files)" />
  <button onclick="send()" id="sendfile">提交(1/3)</button>

  <p id="text"></p>
  <input type="text" id="key" />
  <button onclick="recv()" id="recvfile">下载</button>
</body>

</html>